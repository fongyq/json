<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <title>json-viewer</title>

        <link rel="icon" href="./magnum.ico" type="image/x-icon">

        <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/5.0.0/diff.min.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.1/styles/github.min.css" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css" />
        <script src="https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js"></script> -->

        <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/perl/perl.min.js"></script>
        <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.css" />
        <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/abbott.min.css" />
        <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/elegant.min.css" />
        <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/mdn-like.min.css" /> -->
        
        <!-- json viewer -->
        <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
        <script src="./jquery.json-viewer-master/json-viewer/jquery.json-viewer.js"></script>
        <link href="./jquery.json-viewer-master/json-viewer/jquery.json-viewer.css" type="text/css" rel="stylesheet">

        <!-- mode -->
        <script src="./codemirror/codemirror-5.65.16/lib/codemirror.js"></script>
        <script src="./codemirror/codemirror-5.65.16/mode/perl/perl.js"></script>
        <script src="./codemirror/codemirror-5.65.16/mode/python/python.js"></script>
        <script src="./codemirror/codemirror-5.65.16/mode/clike/clike.js"></script>
        <script src="./codemirror/codemirror-5.65.16/mode/shell/shell.js"></script>
        <script src="./codemirror/codemirror-5.65.16/mode/sql/sql.js"></script>
        <script src="./codemirror/codemirror-5.65.16/mode/markdown/markdown.js"></script>
        <script src="./codemirror/codemirror-5.65.16/mode/gfm/gfm.js"></script>
        <script src="./codemirror/codemirror-5.65.16/mode/rst/rst.js"></script>
        <script src="./codemirror/codemirror-5.65.16/addon/mode/overlay.js"></script>
        <script src="./codemirror/codemirror-5.65.16/mode/htmlmixed/htmlmixed.js"></script>
        <script src="./codemirror/codemirror-5.65.16/mode/xml/xml.js"></script>
        <script src="./codemirror/codemirror-5.65.16/mode/css/css.js"></script>
        <script src="./codemirror/codemirror-5.65.16/mode/javascript/javascript.js"></script>
        <!-- theme -->
        <link rel="stylesheet" type="text/css" href="./codemirror/codemirror-5.65.16/lib/codemirror.css" >
        <link rel="stylesheet" type="text/css" href="./codemirror/codemirror-5.65.16/theme/abbott.css" >
        <link rel="stylesheet" type="text/css" href="./codemirror/codemirror-5.65.16/theme/elegant.css" >
        <link rel="stylesheet" type="text/css" href="./codemirror/codemirror-5.65.16/theme/eclipse.css" >
        <link rel="stylesheet" type="text/css" href="./codemirror/codemirror-5.65.16/theme/mdn-like.css" >
        <!-- 代码折叠 -->
        <link rel="stylesheet" href="./codemirror/codemirror-5.65.16/addon/fold/foldgutter.css"/>
        <script src="./codemirror/codemirror-5.65.16/addon/fold/foldcode.js"></script>
        <script src="./codemirror/codemirror-5.65.16/addon/fold/foldgutter.js"></script>
        <script src="./codemirror/codemirror-5.65.16/addon/fold/brace-fold.js"></script>
        <script src="./codemirror/codemirror-5.65.16/addon/fold/comment-fold.js"></script>
        <script src="./codemirror/codemirror-5.65.16/addon/fold/indent-fold.js"></script>
        <!-- search -->
        <link rel="stylesheet" href="./codemirror/codemirror-5.65.16/addon/dialog/dialog.css"/>
        <script src="./codemirror/codemirror-5.65.16/addon/dialog/dialog.js"></script>
        <script src="./codemirror/codemirror-5.65.16/addon/search/search.js"></script>
        <script src="./codemirror/codemirror-5.65.16/addon/search/searchcursor.js"></script>
        <script src="./codemirror/codemirror-5.65.16/addon/search/jump-to-line.js"></script>
        <script src="./codemirror/codemirror-5.65.16/addon/search/match-highlighter.js"></script>
        <!-- 全屏模式 -->
        <link rel="stylesheet" href="./codemirror/codemirror-5.65.16/addon/display/fullscreen.css">
        <script src="./codemirror/codemirror-5.65.16/addon/display/fullscreen.js"></script>
        <!-- 括号匹配 -->
        <script src="./codemirror/codemirror-5.65.16/addon/edit/matchbrackets.js"></script>

        <link rel="stylesheet" href="./codemirror/codemirror-5.65.16/addon/scroll/simplescrollbars.css">
        <script src="./codemirror/codemirror-5.65.16/addon/scroll/simplescrollbars.js"></script>

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.8/clipboard.min.js"></script>
        
        <link rel="stylesheet" href="./custom.css"/>
        
    </head>
    <body>
        <div style="text-align:center;">
            <div class="tooltip fa-regular fa-question-circle">
                <span class="tooltiptext">
                    <li>光标位于文本框内，F11 / Ctrl-B 全屏，Esc 退出全屏。</li>
                    <br/>
                    <li>光标位于左侧输入框内，Ctrl-F / Cmd-F 搜索，Ctrl-G / Cmd-G 查找下一个，Shift-Ctrl-G / Shift-Cmd-G 查找上一个，Shift-Ctrl-F / Cmd-Option-F 替换，Alt-G 跳到指定行。</li>
                    <br/>
                    <li>取消勾选「WrapArray」只对包含简单类型元素（数值、布尔值、字符串、null）的数组生效（不换行）。</li>
                    <br/>
                    <li>「Html-li」模式使用&lt;li&gt;元素的 margin 作为缩进，拷贝文本会失去缩进；「Html-p」模式使用空格作为缩进（默认四个空格），拷贝文本可以保持缩进，但是长行自动换行时会失去缩进。</li>
                </span>
            </div>
            <select id="code-mode" class="selector" style="width: 9rem;" onchange="setLangMode(event)" title="编辑器语言">
                <option value="text/plain" selected>Plain</option>
                <option value="text/x-csrc">C</option>
                <option value="text/x-c++src">C++</option>
                <option value="text/x-python">Python</option>
                <option value="text/x-java">Java</option>
                <option value="text/x-sh">Shell</option>
                <option value="text/x-sql">SQL</option>
                <option value="text/x-markdown">Markdown</option>
                <option value="text/x-rst">Rst</option>
                <option value="text/html">HTML</option>
                <option value="text/css">CSS</option>
                <option value="text/javascript">JavaScript</option>
                <option value="text/x-perl">Perl</option>
            </select>
            <select id="code-theme" class="selector" style="width: 7.6rem;" onchange="setTheme(event)" title="编辑器主题">
                <option value="abbott">Abbott</option>
                <option value="eclipse" selected>Eclipse</option>
                <option value="elegant">Elegant</option>
                <option value="mdn-like">Mdn-like</option>
            </select>
            <select id="font-size" class="selector" style="width: 5rem;" onchange="setFontSize(event)" title="字体大小">
                <option value=24>24px</option>
                <option value=22>22px</option>
                <option value=20>20px</option>
                <option value=18 selected>18px</option>
                <option value=16>16px</option>
                <option value=14>14px</option>
                <option value=12>12px</option>
                <option value=10>10px</option>
                <option value=8 > 8px</option>
            </select>
            <select id="view-version" class="selector" style="width: 7rem;" onchange="setViewVersion(event)" title="json2html版本">
                <option value=1 selected>Html-li</option>
                <option value=2>Html-p</option>
            </select>
            <select id="view-indent" class="selector" style="width: 3rem;" onchange="setIndentUnit(event)" title="缩进单元">
                <option value=4 selected>4</option>
                <option value=2>2</option>
            </select>
            <button class="button" data-clipboard-target="#view" title="复制格式化json">Copy</button>
            <button onclick="clearText()" class="button" title="清空文本框">Clear</button>
            <label title="简单类型数组换行" class="check-box">
                <input type="checkbox" id="check-simple-array-wrap" onclick="checkSimpleArrayWrap(this)" checked>WrapArray</label>
            <label title="长行自动换行" class="check-box">
                <input type="checkbox" id="check-wrap" onclick="checkWrap(this)" checked>WrapOverflow</label>
        </div>
        <div class="popup" id="popup-success">复制成功</div>
        <div class="popup" id="popup-failure">复制失败</div>
        <br>
        <div class="editor-container">
            <div class="editor" id="text1">
                <textarea id="code" name="code">
{
    "id": 1001,
    "type": "donut",
    "name": "Cake",
    "description": "https://en.wikipedia.org/wiki/Doughnut",
    "price": 2.55,
    "available": {
        store: 42,
        warehouse: true
    },
    "toppings": [
        { "id": 5001, "type": null },
        { "id": 5002, "type": "Glazed" },
        { "id": 5005, "type": "Sugar" },
        { "id": 5003, "type": "Chocolate" },
        { "id": 5004, "type": "Maple" }
    ],
    "uuids": [
        "826b23ce-2669-4122-981f-3e2e4429159d",
        "e32111a0-6a87-49ab-b58f-a01bf8d28ba0",
        "c055a894-698e-41c0-b85f-7510a7351d9d",
    ],
}
                </textarea>
            </div>
            <div class="viewer" id="text2">
                <pre id="view" name="view" oninput="render()"></pre>
            </div>

        </div>
        <script>
            var editor = CodeMirror.fromTextArea(document.getElementById('code'), {
                lineNumbers: true,
                lineWrapping: true,
                scrollbarStyle: "overlay",
                indentUnit: 4,
                mode: 'text/plain',
                matchBrackets: true,
                theme: 'eclipse',
                styleActiveLine: true,
                foldGutter: true,
                gutters:["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
                extraKeys: {
                    "Ctrl-B": function(cm) {
                        cm.setOption("fullScreen", !cm.getOption("fullScreen"));
                    },
                    "F11": function(cm) {
                        cm.setOption("fullScreen", !cm.getOption("fullScreen"));
                    },
                    "Esc": function(cm) {
                        if(cm.getOption("fullScreen")) cm.setOption("fullScreen", false);
                    }
                }
            });
            editor.on('change', () => {
                render();
            });
            function setLangMode(event) {
                var mode = event.target.value;
                editor.setOption("mode", mode);
            }
            function setTheme(event) {
                var theme = event.target.value;
                editor.setOption("theme", theme);
            }
            function setFontSize(event) {
                var fs = event.target.value;
                document.getElementById("text2").style.fontSize = fs + "px";
                document.getElementById("text2").style.lineHeight = Math.ceil(fs * 1.67) + "px";
                editor.getWrapperElement().style["font-size"] = fs + "px";
                editor.getWrapperElement().style["line-height"] = Math.ceil(fs * 1.33) + "px";
                editor.refresh();
            }
            var option = {
                collapsed: false, 
                withQuotes: true, 
                withLinks: false,
                wrapSimpleArray: true,
                indentUnit: 4,
                json2htmlVersion: 1
            };
            function render() {
                var text = editor.getDoc().getValue("\n");
                if (text == "") {
                    document.getElementById("view").innerHTML = "";
                } else {
                    try {
                        var json = eval('(' + text + ')');
                        $('#view').jsonViewer(json, option);
                    } catch (e) {
                        reportError(e);
                    }
                }
            }
            window.onerror = function(message, source, lineno, colno, error) {
                document.getElementById("view").innerHTML = error;
                document.getElementById("view").innerHTML += "<br> Line: " + lineno + ", Column: " + colno;
            };
            function checkSimpleArrayWrap(obj) {
                if (obj.checked) {
                    option.wrapSimpleArray = true;
                } else {
                    option.wrapSimpleArray = false;
                }
                render();
            }
            function setIndentUnit(obj) {
                var unit = event.target.value;
                option.indentUnit = parseInt(unit);
                render();
            }
            function setViewVersion(obj) {
                var version = event.target.value;
                option.json2htmlVersion = parseInt(version);
                render();
            }
            function checkWrap(obj) {
                if (obj.checked) {
                    document.getElementById("view").style.whiteSpace = "normal";
                    document.getElementById("view").style.wordWrap = "break-word";
                    document.getElementById("view").style.overflowWrap = "break-word";
                    editor.setOption("lineWrapping", true);
                } else {
                    document.getElementById("view").style.whiteSpace = "nowrap";
                    document.getElementById("view").style.wordWrap = "normal";
                    document.getElementById("view").style.overflowWrap = "normal";
                    editor.setOption("lineWrapping", false);
                }
            }
            function forceWrap() {
                document.getElementById("view").style.whiteSpace = "normal";
                document.getElementById("view").style.wordWrap = "break-word";
                document.getElementById("view").style.overflowWrap = "break-word";
            }
            function clearText() {
                editor.setValue("");
                render();
            }
            var isOnView = false;
            document.getElementById("text1").addEventListener("mouseenter", function(){
                console.log("enter text1");
                isOnView = false;
            });
            document.getElementById("text2").addEventListener("mouseenter", function(){
                console.log("enter text2");
                isOnView = true;
            });
            document.getElementById("view").addEventListener("mouseenter", function(){
                console.log("enter view");
                isOnView = true;
            });
            document.addEventListener("keydown", function(event) {
                var textarea = document.getElementById('text2');
                // 光标在 viewer 文本框才触发全屏快捷键
                if (isOnView && (event.key == "F11" || (event.ctrlKey && (event.key == 'b' || event.key == 'B')))) {
                    if (event.key == "F11") event.preventDefault();
                    console.log("fullscreen");
                    textarea.classList.toggle("fullscreen");
                }
                if (textarea.classList.contains("fullscreen")) {
                    if (event.key == "Escape") {
                        console.log("exit fullscreen");
                        textarea.classList.toggle("fullscreen");
                    }
                }
            });
            window.addEventListener("load", render());
            window.addEventListener("load", forceWrap());
            // 监听 copy 行为，把拷贝文本中的空行删除
            document.addEventListener('copy', (event) => {
                var toCopy = document.getSelection().toString();
                var lines = toCopy.split("\n").filter(line => line.trim());
                // console.log(lines);
                var toPaste = lines.join("\n");
                event.clipboardData.setData('text/plain', toPaste);
                event.preventDefault();
            });
            var clipboard = new ClipboardJS('.button');
            function popElement(name) {
                var popup = document.getElementById(name);
                popup.style.display = 'flex';
                setTimeout(() => {
                    popup.style.display = 'none';
                }, 1000);
            }
            clipboard.on('success', function(event) {
                event.clearSelection();
                popElement("popup-success");
            });
            clipboard.on('error', function(event) {
                console.log('复制失败 ' + event.action);
                popElement("popup-failure");
            });
        </script>
    </body>
</html>